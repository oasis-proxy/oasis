# 自动策略 (基于规则的路由)

自动策略是 Oasis 规则策略路由引擎的核心，支持定义基于请求 URL 或 IP 的代理分配规则。

## 1. 入口与导航

### 创建策略

- 在选项页 **侧边栏 (Sidebar)** 的“策略路由”标题旁，点击 **(+)** 图标即可创建新的自动策略。

### 管理现有策略

- 在侧边栏选中特定策略后，可以在右侧详情页的 **顶部标题栏 (Header)** 执行以下操作：
  - **弹出页面显示**: 通过标题栏的“在弹出页面显示”开关，控制该策略是否出现在扩展 Popup 菜单中。
  - **更多操作**: 点击最右侧的三个点图标展开菜单：
    - **重命名/克隆/删除**: 修改策略基本信息。
    - **导出 PAC**: 将当前策略导出为静态脚本。
    - **合并策略 (Merge Policy)**: 点击标题栏菜单中的“合并策略”图标，可以将另一个策略的所有规则导入当前策略（支持忽略重复或覆盖冲突）。

---

## 2. 规则类型与匹配模式

Oasis 支持四种主要的规则类型：

- **通配符 (Wildcard)**: 灵活的域名模式匹配。
  - `google.com`: 精确匹配 `google.com` 域名。
  - `.google.com`: 匹配 `google.com` 及其 **所有子域名** (如 `www.google.com`)。
  - `*.google.com`: 与 `.google.com` 行为一致，匹配域名及其 **所有子域名**。
  - `**.google.com`: **仅匹配子域名** (如 `www.google.com`)，不包含根域名 `google.com`。
  - `*google*`: 使用模糊匹配（如匹配 `google.com`, `google.com.hk`, `mygoogle.net` 等）。
- **正则表达式 (Regex)**: 适用于复杂匹配场景的高级模式匹配。
- **IP 与 CIDR**: 根据目标 IP 或网络范围（例如：`192.168.1.0/24`）进行匹配。
- **规则集订阅 (RuleSet Subscriptions)**: 支持使用包含自动下载和解析功能的外部规则列表（如 GFWList）。规则集内容格式需符合 **AutoProxy** 规范。

---

## 3. 高级规则操作

### 规则添加

- **添加单条规则**: 点击“常规规则 (Normal Rules)”卡片顶部的 **(+)** 图标。
- **添加规则集**: 在添加新规则行后，将“规则类型 (Rule Type)”下拉菜单切换为 **Rule Set**，并填入订阅订阅 URL。
- **添加分隔符**: 在规则行的操作栏点击“文件夹/收纳”图标，用于在列表中插入可编辑的分类标题。

### 批量操作

- **批量替换代理 (Batch Replace Proxy)**: 点击卡片顶部的 **“列表/检查”** 图标。此功能允许将当前策略中所有使用特定代理的规则批量替换为另一个代理。
- **AutoProxy 预览**: 提供对源规则（通配符、正则表达式类型）的实时 AutoProxy 预览以及复制功能。
- **规则合并 (Smart Merge)**: 提供对精确匹配域名规则的合并功能，支持对多个根域名相同的子域名做通配符自动合并，并替换原规则。简化规则数量。

### 策略合并 (Smart Merge)

**策略合并** 功能允许将另一个策略的规则导入当前策略，并提供智能冲突解决机制。通过标题栏的 **更多操作**（三个点）菜单访问：

- **源策略选择**: 选择任意现有的自动策略作为来源。
- **规则类型**: 选择导入“常规规则 (Normal Rules)”、“拒绝规则 (Reject Rules)”或两者。
- **冲突解决**:
  - **忽略 (Ignore)**: 跳过目标策略中已存在的规则。
  - **覆盖 (Overwrite)**: 使用源策略的版本更新目标策略中的现有规则。

### 规则集管理

- **格式支持**: 订阅支持 **AutoProxy (Base64)** 和 **AutoProxy 纯文本** 格式。
- **离线韧性**: 系统会自动进行本地缓存，确保在订阅链接处于离线状态时路由策略依然可用。
- **实时检查**: 通过“查看内容”功能可实时检查已下载并解析后的规则列表。

### 外部规则集预览

- **预览**: 点击详情页顶部的 **“眼睛”** 图标，可将整个策略（包括所有规则和订阅的 RuleSet）作为生成的 AutoProxy 文件进行预览。

---

## 4. 优先级逻辑

规则按从上到下的顺序进行评估，并遵循全局优先级权重（参考配置项：`通用配置` -> `优先级`）：

1. **拒绝规则 (Reject Rules)**: 最先被评估。匹配请求将被立即阻止并重定向。
2. **临时规则 (Temporary Rules)**: 通过“快速添加”生成的仅限当前会话的规则。详见 [临时规则指南](TEMPORARY_RULES.md)。
3. **正常规则 (Normal Rules)**: 策略内的持久规则，支持通过拖拽调整优先级。
4. **默认策略 (Default Strategy)**: 在没有匹配规则时应用的兜底设置。

---

## 5. 未保存更改保护 (Unsaved Changes)

自动策略详情页应用了严格的页面切换保护机制：

- **锁定状态**: 若当前策略存在未保存的修改（规则增删、排序调整或属性编辑），侧边栏导航将被锁定。
- **解除锁定**: 必须点击页面顶部的 **Save** 按钮以持久化配置，或点击 **Reset** 按钮放弃当前会话的修改。
- **目的**: 防止因意外误操作而丢失复杂的路由规则。

---

## 技术参考

- [代理节点配置](PROXY_TYPES.md)
- [请求监控](MONITORING.md)
- [扩展配置](EXTENSION_CONFIG.md)
