name: Build and Package Browser Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Upgrade npm
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm install || (ls -R /home/runner/.npm/_logs/ && cat /home/runner/.npm/_logs/*.log && exit 1)

      - name: Build Project
        run: npm run build:self

      - name: Restore Private Key
        run: echo "${{ secrets.EXTENSION_PRIVATE_KEY }}" > extension.pem

      - name: Calculate Extension ID and Update XML
        id: update_xml
        run: |
          # 1. Get Extension ID using the tool
          # The tool outputs "Extension ID: <id>"
          EXT_ID=$(node tools/generate_key.cjs extension.pem | grep "Extension ID:" | awk '{print $3}')
          echo "Calculated Extension ID: $EXT_ID"

          # 2. Get Version from ref (e.g. v2.0.1 -> 2.0.1)
          VERSION=${GITHUB_REF_NAME#v}
          echo "Version: $VERSION"

          # 3. Define Codebase URL (GitHub Release Asset)
          # Assuming the CRX will be named 'oasis-proxy-extension.crx' in the release
          CODEBASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/oasis-proxy-extension.crx"

          # 4. Update update_sample.xml
          # We use a temporary file to avoid inline editing issues
          cp update_sample.xml update.xml
          sed -i "s/appid='.*'/appid='$EXT_ID'/" update.xml
          sed -i "s/version='.*'/version='$VERSION'/" update.xml
          sed -i "s|codebase='.*'|codebase='$CODEBASE_URL'|" update.xml

          echo "Generated update.xml content:"
          cat update.xml

      - name: Package Chrome Extension as CRX
        run: |
          # Pack the extension
          google-chrome --pack-extension=$(pwd)/dist --pack-extension-key=$(pwd)/extension.pem

      - name: Prepare Release Files
        id: make_release_files
        run: |
          mkdir -p release
          # Move CRX and rename to fixed name for consistency with codebase url
          mv *.crx release/oasis-proxy-extension.crx
          # Copy update.xml to release
          cp update.xml release/update.xml

          cd dist
          zip -r ../release/oasis-proxy-extension.zip .

          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oasisproxy-release
          path: release/

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref }}
          name: ${{ format('Oasis-Proxy-{0}', steps.make_release_files.outputs.TAG_NAME) }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: 'release/*'
